    <?php    /**    * 1.セッションスタート    */    session_start();    /**    * 2.直リンクなら入力画面へ戻す,ワンタイムチケットの確認    */    // 直リンクの確認    if($_POST['referer'] == "" || $_POST['referer'] != "input"){        header("Location:input.php");        exit;    }    // ワンタイムチケットの確認    if(isset($_POST['ticket']) && isset($_SESSION['ticket'])){        $ticket = $_POST['ticket'];        if($ticket != $_SESSION['ticket']){            header("Location:input.php");            exit;        }    }else{           }    /**    * 3.マジッククォートの設定がONならエスケープ文字を削除    */    if(get_magic_quotes_gpc()){    $_POST['name'] = stripslashes($_POST['name']);    $_POST['mail'] = stripslashes($_POST['mail']);    $_POST['text'] = stripslashes($_POST['text']);    }    /**    * 4.input.phpからの値（POSTされた値）をセッションに代入    */    $_SESSION['name'] = htmlspecialchars($_POST['name']);    $_SESSION['mail'] = htmlspecialchars($_POST['mail']);    $_SESSION['text'] = htmlspecialchars($_POST['text']);    $_SESSION['tmp_name'] = htmlspecialchars($_FILES['upfile']['tmp_name']);// echo htmlspecialchars(md5($_FILES['upfile']['name']));    /**    * 5.入力チェック    */    $flg = 0;    $_SESSION['errMsg'] = "";    //    //入力文字のチェックを変数でまとめる    //    $check_mail = "/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/";    $check_url = "/^(https?|ftp)(:\/\/[-_.!~*\'()a-zA-Z0-9;\/?:\@&=+\$,%#]+)$/";    $check_hankaku = "/^[!-~]*$/";    $check_hankaku_eisu = "/^[a-zA-Z0-9]*$/";    $check_hankaku_eiji = "/^[a-zA-Z]*$/";    $check_num = "/^[0-9]*$/";    $check_num_hyphen = "/^[0-9-]*$/";    $check_hiragana = "/^[ぁ-ゞ]*$/";    $check_zenkaku_katakana = "/^[ｱ-ﾝﾞﾟ]*$/";    $check_zenkaku = "/^[^ -~｡-ﾟ]*$/";    // お名前項目チェック    if($_SESSION['name'] == ""){        $flg = 1;        $_SESSION['errMsg']['name'] = "お名前が入力されておりません";    }    // メールアドレス項目チェック    if($_SESSION['mail'] == ""){        $flg = 1;        $_SESSION['errMsg']['mail'] = "メールアドレスが入力されておりません";    }    if($_SESSION['mail'] != ""){        if(!preg_match($check_mail, $_SESSION['mail'])){            $flg = 1;            $_SESSION['errMsg']['mail'] = "メールアドレスの形式ではありません";        }    }       // 内容項目チェック    if($_SESSION['text'] != ""){        $strNum = 500;  // 制限文字数        $length = mb_strlen($_SESSION['text'], "UTF-8");        if($length < 0 || $length > $strNum){            $flg = 1;            $_SESSION['errMsg']['text'] = "内容の文字数がオーバーしています";        }    }       //MAX_UPLOAD_FILE_SIZE のみ別if文で処理    if($_FILES['upfile']['error'] === 1){         $flg = 1;        $_SESSION['errMsg']['upfile'] = "ファイルのサイズが不明です。ファイルサイズは1.5MBまでです。";    }    // 一時ファイルがあった場合    if($_FILES['upfile']['tmp_name']){        $img_list = array('image/jpg','image/jpeg','image/png','image/gif');        //拡張子チェック       if(!in_array($_FILES['upfile']['type'], $img_list)){            $flg = 1;            $_SESSION['errMsg']['upfile'] = "拡張子が違います";        //MAX_UPLOAD_FILE_SIZEと上限指定の間の場合はこちらのエラー       }elseif($_FILES['upfile']['size'] >= 1580000){            $flg = 1;            $_SESSION['errMsg']['upfile'] = "ファイルのサイズが大きすぎます。1.5MBまでです。";        //それ以外は一時ファイルの移動して保存       }else{              $updir = "files/";              $filename = $_FILES['upfile']['name'];              $ex_name = explode(".", $filename);                            // ファイル名の変更              $filename = md5($ex_name[0]).'.'.$ex_name[1];            // 変更したファイル名をセッションに保存                $_SESSION['upfile'] = htmlspecialchars($filename);              if(move_uploaded_file($_FILES['upfile']['tmp_name'], $updir.$filename)==FALSE){                $result_txt = $_FILES['upfile']['error'];              } else {                $result_txt = '<img src="files/'.$filename.'">';                              }       }    // 一時ファイルがなくかつセッションファイルが残っている場合    }elseif($_SESSION['upfile'] && $_FILES['upfile']['tmp_name'] == ""){        $result_txt = '<img src="files/'.$_SESSION['upfile'].'">';    }else{        $result_txt = '画像添付なし';    }    if($flg){        header("Location:input.php");        exit;    }    ?>    <!DOCTYPE HTML>    <html>    <head>        <meta charset="UTF-8">        <title>確認画面</title>        <style>        <!--        #form table{        border-top:1px solid #CCC;        border-right:1px solid #CCC;        }        #form table td,#form table th{        border-bottom:1px solid #CCC;        border-left:1px solid #CCC;        padding:5px;        }        #form table th{        background:#EEE;        }        .center{        text-align:center;        }        -->        </style>        <script type="text/javascript">            function postData(_obj, target) {                _obj.action = target;                _obj.submit();            }        </script>    </head>    <body>        <div id="form">            <form id="Form" name="form" method="post" action="send.php">            <input type="hidden" id="referer" name="referer" value="confirm">            <input type="hidden" id="ticket" name="ticket" value="<?php echo $ticket; ?>">                <table cellpadding="0" cellspacing="0">                    <tr>                        <th colspan="2">確認画面</th>                    </tr>                    <tr>                        <td>お名前</td>                        <td>                            <?php echo $_SESSION['name']; ?>                        </td>                    </tr>                    <tr>                        <td>メールアドレス</td>                        <td>                            <?php echo $_SESSION['mail']; ?>                        </td>                    </tr>                    <tr>                        <td>内容</td>                        <td>                            <?php echo nl2br($_SESSION['text']); ?>                        </td>                    </tr>                    <tr>                        <td>画像</td>                        <td><?php echo $result_txt; ?></td>                    </tr>                    <tr>                        <td class="center" colspan="2">                            <input type="submit" value="戻る" onclick="postData(document.getElementById('Form'), 'input.php'); return false;">                            <input type="submit" value="送信" onclick="postData(document.getElementById('Form'), 'send.php'); return false;">                        </td>                    </tr>                </table>            </form>        </div>    </body>    </html>